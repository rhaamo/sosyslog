# $CoreSDI: Makefile.in,v 1.20 2000/07/04 20:49:53 claudio Exp $
#
# Copyright (c) 2000, Core SDI S.A., Argentina
# All rights reserved
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither name of the Core SDI S.A. nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

CC=		@CC@
LD=		ld
CFLAGS=		@CFLAGS@
LDFLAGS=	@LDFLAGS@
CPPFLAGS=	-I. -I..
LDCONFIG_FLAGS=	@LDCONFIG_FLAGS@
INSTALL_LIBDIR=	@INSTALL_LIBDIR@

SSRCS=		@SSRCS@
SOBJS=		${SSRCS:.c=.o}
DUNIX=		@Dunix@
DUDP=		@Dudp@
DBSD=		@Dbsd@
DLINUX=		@Dlinux@
DCLASSIC=	@Dclassic@
DPEO=		@Dpeo@
SHASH_SRCS=	@SHASH_SRCS@
DHASH_SRCS=	@DHASH_SRCS@
SHASH_OBJS=	${SHASH_SRCS:.c=.o}
DHASH_OBJS=	${DHASH_SRCS:.c=.o}
DMYSQL=		@Dmysql@
DPGSQL=		@Dpgsql@
DREGEX=		@Dregex@
DUNIX_SRC=	@Dunix_SRC@
DUDP_SRC=	@Dudp_SRC@
DBSD_SRC=	@Dbsd_SRC@
DLINUX_SRC=	@Dlinux_SRC@
DCLASSIC_SRC=	@Dclassic_SRC@
DPEO_SRC=	@Dpeo_SRC@
DMYSQL_SRC=	@Dmysql_SRC@
DPGSQL_SRC=	@Dpgsql_SRC@
DREGEX_SRC=	@Dregex_SRC@
DUNIX_OBJ=	${DUNIX_SRC:.c=.o}
DUDP_OBJ=	${DUDP_SRC:.c=.o}
DBSD_OBJ=	${DBSD_SRC:.c=.o}
DLINUX_OBJ=	${DLINUX_SRC:.c=.o}
DCLASSIC_OBJ=	${DCLASSIC_SRC:.c=.o}
DPEO_OBJ=	${DPEO_SRC:.c=.o}
DMYSQL_OBJ=	${DMYSQL_SRC:.c=.o}
DPGSQL_OBJ=	${DPGSQL_SRC:.c=.o}
DREGEX_OBJ=	${DREGEX_SRC:.c=.o}

DYNAMIC_COMP=	${CC} ${CFLAGS} ${CPPFLAGS} -fPIC -c
DYNAMIC_LINK=	${LD} -Bshareable

all: DYNAMIC_LIBS ${SOBJS}

$(SOBJS) DYNAMIC_LIBS: ../config.h

$(SOBJS):
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $(SSRCS) $(SHASH_SRCS:%=../peo/%)

DYNAMIC_LIBS:	$(DUNIX) $(DUDP) $(DBSD) $(DLINUX) \
		$(DCLASSIC) $(DPEO) $(DMYSQL) $(DPGSQL) $(DREGEX)

${DUNIX}:
	${DYNAMIC_COMP} ${DUNIX_SRC}
	${DYNAMIC_LINK} -o $@ ${DUNIX_OBJ}

$(DUDP): 
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DUDP_SRC)
	$(LD) -Bshareable -o $@ $(DUDP_OBJ)

$(DBSD):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DBSD_SRC)
	$(LD) -Bshareable -o $@ $(DBSD_OBJ)

$(DLINUX):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DLINUX_SRC)
	$(LD) -Bshareable -o $@ $(DLINUX_OBJ)

$(DCLASSIC):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DCLASSIC_SRC)
	$(LD) -Bshareable -o $@ $(DCLASSIC_OBJ)

$(DPEO):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DPEO_SRC) $(DHASH_SRCS:%=../peo/%)
	$(LD) -Bshareable -o $@ $(DPEO_OBJ) $(DHASH_OBJS)

$(DMYSQL):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DMYSQL_SRC)
	$(LD) -Bshareable -o $@ $(DMYSQL_OBJ)

$(DPGSQL):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DPGSQL_SRC)
	$(LD) -Bshareable -o $@ $(DPGSQL_OBJ)

$(DREGEX):
	$(CC) $(CFLAGS) $(CPPFLAGS) -fPIC -c $(DREGEX_SRC)
	$(LD) -Bshareable -o $@ $(DREGEX_OBJ)

.PHONY:	clean distclean
clean:
	-rm -f core *.core *.o *.so.*

distclean: clean
	-rm -f Makefile

install:
	-chmod 111 libmsyslog_*.so.* && cp -f libmsyslog_*.so.* ${INSTALL_LIBDIR}
	-if test "`uname`" = "Linux"; \
	then \
		if test -z "`grep ${INSTALL_LIBDIR} /etc/ld.so.conf`"; \
		then \
			echo "${INSTALL_LIBDIR}" >> /etc/ld.so.conf; \
		fi; \
		ldconfig; \
	else \
		ldconfig ${LDCONFIG_FLAGS} ${INSTALL_LIBDIR} \
	fi



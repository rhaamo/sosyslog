.\" Copyright (c) 2000
.\"	Core-SDI SA. All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgment:
.\"    This product includes software developed by Core-SDI SA and its
.\"    contributors.
.\" 4. Neither the name of Core-SDI SA nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.ta 3m 3m
.Dd May 10, 2000
.Dt PEOCHK 8
.Os Core-SDI
.Sh NAME
.Nm peochk
.Nd Initial key generator and integrity log file checker
.Sh SYNOPSIS
.Nm peochk
.Op Fl f Ar logfile
.Op Fl g
.Op Fl h
.Op Fl i Ar key0file
.Op Fl k Ar keyfile
.Op Fl l
.Op Fl m Ar hash_method
.Op Fl q
.Op \fIlogfile\fP
.Sh DESCRIPTION
.ad b
.Nm peochk
generates the initial key file and checks log files generated by syslogd(8)
using the \fIpeo output module\fP (om_peo(8)). The options are as follows:
.Bl -tag -width Ds
.It Fl f Ar logfile
Specify the pathname of a log file, if \fIlogfile\fP is not specified
using this option data is readed from standard input and the pathname is
used only to generate reports and/or to obtain the key files pathnames
when the \fB-k\fP and/or \fB-i\fP options are not specified;
the default is \fI/var/log/messages\fP.
.It Fl g
Generates two key files with an initial key into them, one in binary mode
(the \fIkeyfile\fP to be used by \fIpeo output module\fP (om_peo(8)))
and the other in ascii mode (the \fIkey0file\fP), the admin should put the
last one into a secure place and remove it from the specified path
(see \fB-i\fP and \fB-k\fP options); when this option is not specified
\fBpeochk\fP is in check mode.
.It Fl h
Displays a little help.
.It Fl i Ar key0file
Specify the initial key pathname; the default is
\fIkeyfile\fP pathname with a "0" char added at the end
(see \fB-k\fP option).
.It Fl k Ar keyfile
Specify the key pathname (this file is used by the \fIpeo output module\fP
(om_peo(8)) to generate a hash key from the last logged message);
the default is \fI/var/ssyslogd/xxx.key\fP where \fIxxx\fP is the \fIlogfile\fP
(specified with \fB-f\fP option or without it) with all '/' replaced by '.'.
.It Fl l
Used in check mode to detect the first corrupted line; when specified
with the \fB-g\fP option it creates a \fImac\fP file with the same pathname
as \fIkeyfile\fP with a ".mac" string added at the end.
.It Fl m Ar hash_method
Specifies the hash method used to generate the keys, \fIhash_method\fP
should be one of \fImd5\fP, \fIsha1\fP, or \fIrmd160\fP;
the default is \fIsha1\fP.
.It Fl q
Quiet mode; prints '0' on stdout when logfile is not corrupted, and '1' or
number (see \fB-l\fP option) when the logfile is corrupted.
.El
.Sh EXAMPLES
If you want to protect the file /var/log/authlog you can:
.Pp
.in +3m
.ll -3m
.ad b
1. run the command:
.Pp
	\fBpeochk -g -f /var/log/authlog -i authkey0 -m rmd160 -l\fP
.Pp
this will generate the \fI/var/ssylog/var.log.authlog.key\fP file
with the initial key in binary mode and the \fI./authkey0\fP file with that
key translated to ascii, the hash method used to generate the key is
\fIrmd160\fP, the \fI-l\fP option activates the line corrupted detection
mode, it creates the file \fI/var/ssyslog/var.log.authlog.key.mac\fP
You should memorice the contents of \fI./authkey0\fP file and rm(1) it.
.Pp
	
.Pp
2. Edit the syslogd.conf(5) file and enable the \fIpeo output
module\fP (om_peo(8)) with something like this:
.Pp
.in +3m
.ll -3m
.ad l
\fBauth.info  %classic /var/log/authlog
%peo -m rmd160 -l -k /var/ssyslog/.var.log.authlog\fP
.in -3m
.ll +3m
.Pp
3. Inform the new changes on syslogd.conf(5) to syslogd(8):
.Pp
	\fBkill -HUP `cat /var/run/syslog.pid`\fP
.Pp
4. When you believe that someone owned your machine you can:
.Pp
	\fBpeochk -m rmd160 -f /var/log/authlog -i mykey\fP
.Pp
the contents of \fImykey\fP should be the same as \fI./key0file\fP
generated in step 1; with the command above you can verify that the
file was (or not) corrupted (it is important not to forget the \fB-m\fP
option because the default used is \fIsha1\fP and the keys generated
was using \fIrmd160\fP).
.in -3m
.ll +3m
.Sh SEE ALSO
.Xr om_peo 8 ,
.Xr syslogd 8 ,
.Xr syslog.conf 5
.Sh BUGS
if you found bugs, please report them to syslog-bugs@core-sdi.com

# This is a BSDBuild configure script source. The ./configure script is
# generated from this file via mkconfigure(1). For more information, see:
# http://bsdbuild.hypertriton.com/.

REGISTER_SECTION("General")
REGISTER("--with-maximum-optimization",	"Activate maximum possible compile and link optimization")
REGISTER("--with-daemon-name",		"Set a different daemon name, instead of sosyslogd")
REGISTER("--enable-debug",	"General debugging [no]")

REGISTER_SECTION("Modules")
REGISTER("--disable-udp",	"Use udp socket input module. Activated by default.")
REGISTER("--disable-unix",	"Use unix socket domain input module. Activated by default.")
REGISTER("--disable-file",	"Use file/pip input module. Activated by default.")
REGISTER("--disable-streams",	"Use streams input module. Activated by default.")
REGISTER("--disable-classic",	"Use classic output module. Activated by default.")
REGISTER("--disable-tcp",	"Use tcp input and output modules. Activated by default.")
REGISTER("--disable-oracle8i",	"Use Oracle8i output module. Activated by default.")
REGISTER("--disable-mysql",	"Use mysql MySQL output module. Activated by default.")
REGISTER("--disable-pgsql",	"Use pgsql PostgreSQL output module. Activated by default.")
REGISTER("--disable-peo",	"Use peo log integrity verification module. Activated by default.")
REGISTER("--disable-regex",	"Use regex pattern matching output module. Activated by default.")

# Name and version
HDEFINE(PROGNAME, "sosyslog")
HDEFINE(VERSION, "1.3.3")

# Check for a C compiler. If one exists, ${HAVE_CC} will be set
CHECK(cc)

# VARS
MANPAGES="syslog.conf.5 syslogd.3"
MDEFINE(MLIBNAME,	"lib${PROGNAME}.so.${VERSION}")
MAIL_CONTACT="rhaamo@gruik.at"
check_header_state=no

CHECK(dlopen)
if [ "${HAVE_DLOPEN}" != "yes" ]; then
    echo "Could not find DLOPEN"
    exit 1
else
    L_SYSLOGD_LIBS="-ldl"
fi

if [ "${with_maximum_optimization}" = "yes" -o ] ; then
    MAXOPT="yes"
else
    MAXOPT="no"
fi

# TODO: use --with-daemon-name=blah
MDEFINE(SOSYSLOG_DAEMON_NAME,	${PROGNAME}d)

check_your_prefix ()
{
    echo "Please check your $$PREFIX or use something like:"
    echo "  ./configure --prefix=/your/prefix --some-options"
    echo "If you _realy_ have this header please contact the author:"
    echo "${MAIL_CONTACT}"
}

check_header_exist ()
{
    check_header_state="no"
    echo -n "checking for $1... "

    rm -r configure_testdir 2>/dev/null
    mkdir configure_testdir 2>/dev/null
    cd configure_testdir 2>/dev/null
    rm testhead.h 2>/dev/null
    echo "#include <$1>" >> testhead.h
    gcc testhead.h 2>testhead.err
    if [ "$?" = "0" ]; then
        che_state="yes"
	echo "yes"
    else
        che_state="no"
	echo "no"
	check_your_prefix
    fi
    rm testhead.* 2>/dev/null
    cd .. 2>/dev/null
    rm -r configure_testdir 2>/dev/null

    check_header_state=$che_state
}

echo -n "checking Operating System to set libraries flags... "
UNAME=`uname`
if test "${UNAME}" = "OpenBSD" ; then
    HDEFINE(DLOPEN_FLAGS,	RTLD_LAZY)
    HDEFINE(SYMBOL_PREFIX,	"_")

    MDEFINE(SHARED_PARAMS,	"-Bshareable")
    MDEFINE(DCCFLAGS,		"-fPIC")

    echo "OpenBSD"
elif test "${UNAME}" = "FreeBSD" ; then
    HDEFINE(DLOPEN_FLAGS,	RTLD_LAZY)
    HDEFINE(SYMBOL_PREFIX,	)

    MDEFINE(SHARED_PARAMS,	"-Bshareable")
    MDEFINE(DCCFLAGS,		"-fPIC")
    L_SYSLOGD_LIBS="${L_SYSLOGD_LIBS} -Wl,-E"

    echo "FreeBSD"
elif test "${UNAME}" = "NetBSD" ; then
    HDEFINE(DLOPEN_FLAGS,	RTLD_LAZY)
    HDEFINE(SYMBOL_PREFIX,	)

    MDEFINE(SHARED_PARAMS,	"-Dshareable")
    MDEFINE(DCCFLAGS,		"-fPIC")
    L_SYSLOGD_LIBS="${L_SYSLOGD_LIBS} -Wl,-E"

    echo "NetBSD"
elif test "${UNAME}" = "Linux" ; then
    HDEFINE(DLOPEN_FLAGS,	"RTLD_LAZY | RTLD_GLOBAL")
    HDEFINE(SYMBOL_PREFIX,	)

    MDEFINE(MAIN_CPPFLAGS,	"-Xlinker -E")
    MDEFINE(SHARED_PARAMS,	"-Bshareable")
    MDEFINE(DCCFLAGS,		)

    echo "Linux"
elif test "${UNAME}" = "SunOS" ; then
    HDEFINE(DLOPEN_FLAGS,	RTLD_LAZY)
    HDEFINE(_REENTRANT,		1)
    HDEFINE(SYMBOL_PREFIX,	)

    if test "${CC}" = "gcc" ; then
	MDEFINE(DCCFLAGS,	"-Bshared")
    else
	if test "${MAXOPT}" = "yes" ; then
	    MDEFINE(OUR_CFLAGS,	"-g3 -Ofast")
	fi
    fi
    MDEFINE(SHARED_PARAMS,	"-shared -soname ${MLIBNAME} -all")

    echo "SunOS"
elif test "${UNAME}" = "AIX" ; then
    HDEFINE(DLOPEN_FLAGS,	RTLD_LAZY | RTLD_GLOBAL)
    HDEFINE(NEEDS_DLOPEN_NULL,	1)
    HDEFINE(SYMBOL_PREFIX,	)

    MDEFINE(DCCFLAGS,		"-shared")
    MDEFINE(SHARED_PARAMS,	"-lc -bI:libsosyslog.imp -bexpall -bnoentry -brtl")
    cat > src/modules/libsosyslog.imp <<-EOF
    	#! .
	m_dprintf
	logerror
	add_fd_input
	place_signal
	remove_fd_input
	printline
	EOF
    L_SYSLOGD_LIBS="${L_SYSLOGD_LIBS} -Wl,-bexpall"
    echo "AIX"
else
    echo "fail"
    echo "cannot determine system type, failling to defaults"
    HDEFINE(SYMBOL_PREFIX,	)
    HDEFIME(DLOPEN_FLAGS,	RTLD_LAZY)

    MDEFINE(SHARED_PARAMS,	"-Bshareable")
fi
MDEFINE(SYSLOGD_LIBS, ${L_SYSLOGD_LIBS})



if [ "${enable_debug}" = "yes" ]; then
    HDEFINE(SY_DEBUG, "yes")
    MDEFINE(DEBUG_FLAGS, "-g -ggdb3 -fno-inline")
    END_WITH_DEBUG="yes"
else
    HUNDEF(SY_DEBUG)
    END_WITH_DEBUG="no"
fi

# Modules
temp_res="no"
if test "$UNAME" = "OpenBSD" -o "$UNAME" = "NetBSD"	\
    	-o "$UNAME" = "FreeBSD" -o "$UNAME" = "BSDi"	\
	-o "$UNAME" = "386BSD"  -o "$UNAME" = "ArchBSD"	\
	-o "$UNAME" = "TrustedBSD" ; then
	temp_res="yes";
fi

if [ "${temp_res}" = "yes" ]; then
    MSRCS="${MSRCS} im_bsd.c"
    MANPAGES="${MANPAGES} im_bsd.8"
    HDEFINE(HAVE_BSD_MODULE,	1)
    want_bsd=yes
else
    want_bsd=no
fi

temp_res=no
if [ "$UNAME" = "Linux" ]; then
    temp_res=yes
fi

if [ "${temp_res}" = "yes" ]; then
    check_header_exist "sys/klog.h"
    if [ "${check_header_state}" = "yes" ]; then
	MSRCS="${MSRCS} im_linux.c"
	MANPAGES="${MANPAGES} im_linux.8"
	HDEFINE(HAVE_LINUX_MODULE,  1)
	want_linux=yes
    else
	exit 1
	want_linux=no
    fi
else
    want_linux=no
fi

temp_res=no
if [ "${enable_udp}" = "no" ]; then
    want_udp=no
else
    check_header_exist "sys/socket.h"
    if [ "${check_header_state}" = "yes" ]; then
    	MSRCS="${MSRCS} im_udp.c om_udp.c"
	MANPAGES="${MANPAGES} im_udp.8 om_udp.8"
    	HDEFINE(HAVE_UDP_MODULE,	1)
	want_udp=yes
    else
	want_udp=no
    fi
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi

if [ "${enable_}" = "yes" ]; then
    MSRCS="${MSRCS} "
    HDEFINE(HAVE__MODULE,	1)
else
fi


ARCH=`uname -s`
echo
echo "Building ${PROGNAME}-${VERSION} on ${ARCH}"
echo "      Prefix: ${PREFIX}"
echo "          CC: ${CC}"
echo
echo "Build with:"
echo "      Debug: ${END_WITH_DEBUG}"
echo "      Modules:"
echo "          BSD: ${want_bsd}"
echo "        Linux: ${want_linux}"
echo "          UDP: ${want_udp}"
echo
echo "* Configuration successful."
echo "* Use \"make\" and \"make install\" to build and install ${PROGNAME}"


dnl	$CoreSDI: configure.in,v 1.48 2000/07/06 21:06:25 claudio Exp $

AC_INIT(src/syslogd.h)
AC_CONFIG_HEADER(src/config.h)
AC_PROG_CC
AC_PROG_INSTALL

MSYSLOG_VERSION=`awk '/#define VERSION/ { print $3 }' src/syslogd.h`
echo msyslog version... $MSYSLOG_VERSION

CFLAGS="-Wall -O -ggdb"
LDFLAGS=
LDDFLAGS=
DCCFLAGS="-fPIC"
LDCONFIG_FLAGS="-m"
UNAME=`uname`

AC_CHECK_HEADERS(paths.h)

AC_MSG_CHECKING(wheter optreset is needed)
AC_TRY_LINK([#include <unistd.h>],
	[extern int optreset; optreset = 1;],
	[AC_DEFINE(HAVE_OPTRESET) AC_MSG_RESULT(yes)],
	AC_MSG_RESULT(no))

for dir in "/var/run" "/etc"
do
	if test -d $dir
	then
		break
	fi
done
AC_MSG_RESULT(root-mode pid file will go in $dir)
AC_DEFINE_UNQUOTED(PID_DIR, "$dir")

for INSTALL_LIBDIR in "/usr/lib" "/usr/local/lib" "/lib"
do
	if test -d $INSTALL_LIBDIR
	then
		break
	fi
done
AC_MSG_RESULT(dynamic modules will be installed on $INSTALL_LIBDIR)

for INSTALL_DIR in "/usr/sbin" "/usr/local/sbin" "/sbin" \
		   "/usr/bin" "/usr/local/bin" "/bin"
do
	if test -d $INSTALL_DIR
	then
		break
	fi
done
AC_MSG_RESULT(syslogd and tools will be installed on $INSTALL_DIR)

for MANDIR in "/usr/share/man" "/usr/man"
do
	if test -d $MANDIR
	then
		break;
	fi
done
AC_MSG_RESULT(man pages will be installed on $MANDIR)

#AC_ARG_WITH(mysql,
#	[  --with-mysql=DIR        enable MySQL support using libraries in DIR],
#	[with_mysql=$withval],
#	[with_mysql=no])
#test "$with_mysql" = "yes" && AC_DEFINE(ENABLE_MYSQL)
#
#if test "$with_mysql" = "yes"
#then
#	for ac_dir in \
#	/usr/local/mysql \
#	/usr/local/lib/mysql
#	do
#		if test -d "$ac_dir"
#		then
#			with_mysql=$ac_dir
#		fi
#	done
#fi
#
#if test -n "$with_mysql" -a "$with_mysql" != "no"
#then
#	if test "$with_mysql" = "yes"
#	then
#		with_mysql="/usr/local/mysql"	
#	fi
#	echo "Enabling MySQL support in $with_mysql"
#	OMMYSQL_SRC="$OMMYSQL_SRC \$(MYSQL_SRCS)"
#	CFLAGS="$CFLAGS -I$with_mysql/include/mysql"
#	LDFLAGS="$LDFLAGS -L$with_mysql/lib/mysql"
#	OMMYSQL_LIBS="$OMMYSQL_LIBS -lmysqlclient"
#	AC_DEFINE(ENABLE_MYSQL)
#fi

HASH_SRCS="hash.c"
AC_CHECK_FUNC(MD5Init, AC_DEFINE(HAVE_MD5),
	HASH_SRCS="$HASH_SRCS md5c.c")
AC_CHECK_FUNC(SHA1Init, AC_DEFINE(HAVE_SHA1),
	HASH_SRCS="$HASH_SRCS sha1.c")
AC_CHECK_FUNC(RMD160Init, AC_DEFINE(HAVE_RMD160),
	HASH_SRCS="$HASH_SRCS rmd160.c")


if test "$UNAME" = "OpenBSD"
then
	echo Configuring for OpenBSD system
	AC_DEFINE(HAVE_OPENBSD)
elif test "$UNAME" = "Linux"
then
	echo Configuring for Linux system
	LIBS="$LIBS -ldl"
	DCCFLAGS=
	LDDFLAGS="-Xlinker -E"
	AC_DEFINE(HAVE_LINUX)
fi


BEGIN_MODULES_CONF()
CHECK_MODULE(unix, $unix, im_unix.c, im)
CHECK_MODULE(udp, $udp, im_udp.c, im)
CHECK_MODULE(bsd, $bsd, im_bsd.c, im)
CHECK_MODULE(linux, $linux, im_linux.c, im)
CHECK_MODULE(classic, $classic, om_classic.c, om)
CHECK_MODULE(peo, $peo, om_peo.c, om)
if test "x$peo" = "xstatic"
then
	SHASH_SRCS="$HASH_SRCS"
elif test "x$peo" = "xdynamic"
then
	DHASH_SRCS="$HASH_SRCS"
fi
CHECK_MODULE(mysql, $mysql, om_mysql.c sql_misc.c, om)
if test "x$mysql" = "xstatic" -o "x$mysql" = "xdynamic"
then
	CONF_MYSQL()
fi
CHECK_MODULE(pgsql, $pgsql, om_pgsql.c sql_misc.c, om)
if test "x$pgsql" = "xstatic" -o "x$pgsql" = "xdynamic"
then
	CONF_PGSQL()
fi
CHECK_MODULE(regex, $regex, om_regex.c, om)
END_MODULES_CONF()

AC_SUBST(HASH_SRCS)
AC_SUBST(SHASH_SRCS)
AC_SUBST(DHASH_SRCS)
AC_SUBST(LDCONFIG_FLAGS)
AC_SUBST(LIBS)
AC_SUBST(CFLAGS)
AC_SUBST(DCCFLAGS)
AC_SUBST(LDFLAGS)
AC_SUBST(LDDFLAGS)
AC_SUBST(UNAME)
AC_SUBST(INSTALL_LIBDIR)
AC_SUBST(INSTALL_DIR)
AC_SUBST(MANDIR)

AC_OUTPUT([Makefile
	   src/Makefile src/static_modules.h src/static_modules.c
	   src/modules/Makefile
	   src/peo/Makefile
	   src/man/BSDmakefile
	   src/man/GNUmakefile])

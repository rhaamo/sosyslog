AC_INIT(src/syslogd.h)
AC_CONFIG_HEADER(src/config.h)

test -z "$CFLAGS" && CFLAGS=-O AC_SUBST(CFLAGS)
test -z "$LDFLAGS" && LDFLAGS= AC_SUBST(LDFLAGS)

AC_PROG_CC
AC_PROG_INSTALL

AC_CHECK_HEADERS(paths.h)

AC_MSG_CHECKING(wheter optreset is needed)
AC_TRY_LINK([#include <unistd.h>],
	[extern int optreset; optreset = 1;],
	[AC_DEFINE(HAVE_OPTRESET) AC_MSG_RESULT(yes)],
	AC_MSG_RESULT(no))

AC_CHECK_FUNC(MD5Init, AC_DEFINE(HAVE_MD5),
	EXTRA_SRCS="$EXTRA_SRCS peo/md5c.c")

AC_CHECK_FUNC(SHA1Init, AC_DEFINE(HAVE_SHA1),
	EXTRA_SRCS="$EXTRA_SRCS peo/sha1.c")

AC_CHECK_FUNC(RMD160Init, AC_DEFINE(HAVE_RMD160),
	EXTRA_SRCS="$EXTRA_SRCS peo/rmd160.c")

for dir in "/var/run" "/etc"
do
	if test -d $dir
	then
		break
	fi
done

AC_MSG_RESULT(root-mode pid file will go in $dir)
AC_DEFINE_UNQUOTED(PID_DIR, "$dir")

AC_ARG_WITH(mysql,
	[  --with-mysql=DIR        enable MySQL support using libraries in DIR],
	[with_mysql=$withval],
	[with_mysql=no])
test "$with_mysql" = "yes" && AC_DEFINE(MYSQL_ENABLE)

if test "$with_mysql" = "yes"
then
	for ac_dir in \
	/usr/local/mysql \
	/usr/local/lib/mysql
	do
		if test -d "$ac_dir"
		then
			with_mysql=$ac_dir
		fi
	done
fi

if test -n "$with_mysql" -a "$with_mysql" != "no"
then
	if test "$with_mysql" = "yes"
	then
		with_mysql="/usr/local/mysql"	
	fi
	echo "Enabling MySQL support in $with_mysql"
	EXTRA_SRCS="$EXTRA_SRCS \$(MYSQL_SRCS)"
	CFLAGS="$CFLAGS -I$with_mysql/include/mysql"
	LDFLAGS="$LDFLAGS -L$with_mysql/lib/mysql"
	LIBS="$LIBS -lmysqlclient"
	AC_DEFINE(MYSQL_ENABLE)
else
	echo "Disabling MySQL support..."
fi

if test `uname` = "Linux"
then
	echo "Enabling Linux input module..."
	EXTRA_SRCS="$EXTRA_SRCS \$(LINUX_SRCS)"
fi

AC_SUBST(EXTRA_SRCS)

AC_OUTPUT([Makefile src/Makefile])
